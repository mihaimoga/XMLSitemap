<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Backmp11 back-end (C&#43;&#43;17, experimental) :: Boost Libraries Documentation</title>
  <link rel="canonical" href="https://antora.cppalliance.org/master/lib/doc/msm/tutorial/backmp11-back-end.html">
    <link rel="prev" href="back-end.html">
    <link rel="next" href="../performance-compilers.html">
  <meta name="generator" content="Antora 3.1.14">
    <link rel="stylesheet" href="../../_/css/boostlook.css">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/tabs.css">
    <script>var uiRootPath = '../../_'</script>
<link rel="icon" href="../../_/img/favicons/favicon.ico" type="image/x-icon">
    <!-- Favicon configuration -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../_/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_/img/favicons/favicon-16x16.png">
    <link rel="manifest" href="../../_/img/favicons/site.webmanifest">
    <link rel="shortcut icon" href="../../_/img/favicons/favicon.ico">
  </head>
  <body class="article toc2 toc-left">
    <div class="boostlook">
  <div id="header">
    <div id="toc" class="nav-container toc2" data-component="msm" data-version="">
  <aside class="nav">
    <button class="nav-close"></button>
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
      <h3 class="title"><a href="../index.html">Boost.MetaStateMachine</a></h3>
      <ul class="nav-list">
        <ul class="nav-list">
        <li class="" data-depth="1">
            <a class="nav-link" href="../index.html">Table of Contents</a>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../preface.html">Preface</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../founding-idea.html">Founding idea</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../uml-short-guide.html">UML short guide</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../tutorial.html">Tutorial</a>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="3">
            <a class="nav-link" href="basic-front-end.html">Basic front-end</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="functor-front-end.html">Functor front-end</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="puml-front-end.html">PUML front-end (C++20, experimental)</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="euml-front-end.html">eUML front-end (deprecated)</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="back-end.html">Back-end</a>
        </li>
              <li class=" is-current-page" data-depth="3">
            <a class="nav-link" href="backmp11-back-end.html">Backmp11 back-end (C++17, experimental)</a>
        </li>
        </ul>
        <li class="" data-depth="2">
            <a class="nav-link" href="../performance-compilers.html">Performance / Compilers</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../questions-answers-tips.html">Questions &amp; Answers, tips</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../internals.html">Internals</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../acknowledgements.html">Acknowledgements</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../version-history.html">Version history</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../reference.html">Reference</a>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="3">
            <a class="nav-link" href="../reference/external-references-to-msm.html">External references to MSM</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="../reference/euml-operators-and-basic-helpers.html">eUML operators and basic helpers</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="../reference/functional-programming.html">Functional programming</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="../reference/common-headers.html">Common headers</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="../reference/back-end-headers.html">Back-end headers</a>
        </li>
              <li class="" data-depth="3">
            <a class="nav-link" href="../reference/front-end-headers.html">Front-end headers</a>
        </li>
        </ul>
  </ul>
  </ul>
  </ul>
  </nav>
</div>
    </div>
  </aside>
</div>
</div>
  <div id="content">
      <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
    <article class="doc max-width-reset">
  <div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li>
      <a href="../index.html" aria-label="Home: Boost.MetaStateMachine">
        <svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 -960 960 960" fill="#000000" aria-hidden="true"><path d="M160-120v-480l320-240 320 240v480H560v-280H400v280H160Z"/></svg>
      </a>
    </li>
    <li><a href="../index.html">Table of Contents</a></li>
    <li><a href="../tutorial.html">Tutorial</a></li>
    <li><a href="backmp11-back-end.html">Backmp11 back-end (C++17, experimental)</a></li>
  </ul>
</nav>
<div class="spirit-nav">
    <a accesskey="p" href="back-end.html">
      <span class="material-symbols-outlined" title="Previous: Back-end">arrow_back</span>
    </a>
    <a accesskey="u" href="../tutorial.html">
      <span class="material-symbols-outlined" title="Up: Tutorial">arrow_upward</span>
    </a>
    <a accesskey="n" href="../performance-compilers.html">
      <span class="material-symbols-outlined" title="Next: Performance / Compilers">arrow_forward</span>
    </a>
</div></div>
    <h1 class="page">Backmp11 back-end (C&#43;&#43;17, experimental)</h1>
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Backmp11 is a new back-end that is mostly backwards-compatible with <code>back</code>.
It is currently in <strong>experimental</strong> stage, thus some details about the compatibility might change (feedback welcome!).
It is named after the metaprogramming library Boost Mp11, the main contributor to the optimizations.
Usages of MPL are replaced with Mp11 to get rid of the costly C&#43;&#43;03 emulation of variadic templates.</p>
</div>
<div class="paragraph">
<p>The new back-end has the following goals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>reduce compilation time and RAM usage</p>
</li>
<li>
<p>reduce state machine runtime</p>
</li>
<li>
<p>provide new features and customization options</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It offers a significant reduction in compilation time and RAM usage, as can be seen in these benchmarks:</p>
</div>
<div class="paragraph">
<p><strong>Large state machine</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Compile / sec</th>
<th class="tableblock halign-left valign-top">RAM / MB</th>
<th class="tableblock halign-left valign-top">Runtime / sec</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">back</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">953</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">back_favor_compile_time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">back11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">43</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2794</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">backmp11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">239</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">backmp11_favor_compile_time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">220</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">363</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Large hierarchical state machine</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Compile / sec</th>
<th class="tableblock halign-left valign-top">RAM / MB</th>
<th class="tableblock halign-left valign-top">Runtime / sec</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">back</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">68</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2849</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">back_favor_compile_time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2551</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">261</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">backmp11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">472</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">backmp11_favor_compile_time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">288</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">backmp11_favor_compile_time_multi_cu</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~919</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">48</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The full code with the benchmarks and more information about them is available <a href="https://github.com/chandryan/fsm-benchmarks">in this repository</a>.
There are still a couple more optimizations to come, the tables in the repository frequently get updated with the latest results.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deprecation_timeline"><a class="anchor" href="#_deprecation_timeline"></a>Deprecation timeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Deprecations of features with more context information are listed in below table.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 95%;">
<colgroup>
<col style="width: 26.2295%;">
<col style="width: 8.1967%;">
<col style="width: 65.5738%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Feature</th>
<th class="tableblock halign-left valign-top">Deprecation / Removal</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Support for event deferral as action and public access to the deferred event container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.90 / 1.91</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Deferring an event as an action triggered by the same event is not foreseen in UML and leads to ambiguities (the event is both consumed and deferred).</p>
</div>
<div class="paragraph">
<p><strong>Change:</strong> The public API to defer an event will be changed to <code>protected</code>. If needed, users can inherit from <code>state_machine</code> and make the API public again, but without guarantees about correct functionality and API consistency.</p>
</div>
<div class="paragraph">
<p><strong>Recommendation:</strong> Configure event deferral as a state property instead of using it as a transition action.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Public access to the event container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.90 / 1.91</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The event container can be accessed and manipulated via public APIs. Manipulation of the container outside of the library code can lead to undefined behavior.</p>
</div>
<div class="paragraph">
<p><strong>Change:</strong> The public API to access the event container will be changed to <code>protected</code>. If needed, users can inherit from <code>state_machine</code> to access the event container, but without guarantees about correct functionality and API consistency.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_new_features"><a class="anchor" href="#_new_features"></a>New features</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_universal_visitor_api"><a class="anchor" href="#_universal_visitor_api"></a>Universal visitor API</h3>
<div class="paragraph">
<p>The need to define a <code>BaseState</code>, <code>accept_sig</code> and <code>accept</code> method in the front-end is obsolete.</p>
</div>
<div class="paragraph">
<p>Instead there is a universal visitor API that supports traversing through the state machine in multiple modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>only the active states or all states</p>
</li>
<li>
<p>non-recursive or recursive</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// API:
enum class visit_mode
{
    // State selection (mutually exclusive).
    active_states = 0b001,
    all_states    = 0b010,

    // Traversal mode (not set = non-recursive).
    recursive     = 0b100,

    // All valid combinations.
    active_non_recursive = active_states,
    active_recursive     = active_states | recursive,
    all_non_recursive    = all_states,
    all_recursive        = all_states | recursive
};
template&lt;typename Visitor&gt;
void state_machine::visit(Visitor&amp;&amp; visitor); // Same as active_states | recursive
template&lt;visit_mode Mode, typename Visitor&gt;
void state_machine::visit(Visitor&amp;&amp; visitor);

// Assemble your mode...
state_machine machine;
machine.visit
    &lt;visit_mode::all_states | visit_mode::recursive&gt;
    ([](auto &amp;state) {/*...*/});
// ... or use the pre-defined constants
machine.visit
    &lt;visit_mode::all_recursive&gt;
    ([](auto &amp;state) {/*...*/});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The visitor needs to fulfill the following signature requirement for all sub-states present in the state machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">template&lt;typename State&gt;
void operator()(State&amp; state);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also these bugs are fixed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the SM is not started yet, no active state is visited instead of the initial state(s)</p>
</li>
<li>
<p>If the SM is stopped, no active state is visited instead of the last active state(s)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_method_to_check_whether_a_state_is_active"><a class="anchor" href="#_method_to_check_whether_a_state_is_active"></a>Method to check whether a state is active</h3>
<div class="paragraph">
<p>A new method <code>is_state_active</code> can be used to check whether a state is currently active:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">template &lt;typename State&gt;
bool state_machine::is_state_active() const;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the type of the state appears multiple times in a hierarchical state machine, the method returns true if any of the states are active.</p>
</div>
</div>
<div class="sect2">
<h3 id="_simplified_state_machine_signature"><a class="anchor" href="#_simplified_state_machine_signature"></a>Simplified state machine signature</h3>
<div class="paragraph">
<p>The signature has been simplified to facilitate sharing configurations between state machines.
The new signature looks as follows (pseudo-code, the implementation looks a little different):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">template &lt;
    class FrontEnd,
    class Config = default_state_machine_config,
    class Derived = state_machine
&gt;
class state_machine;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define state machine back-ends with a <code>using MyStateMachine = state_machine&lt;&#8230;&#8203;&gt;;</code> declaration or by inheriting from <code>state_machine</code>.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> The parameter <code>Derived</code> has to be set to the derived class, if the <code>state_machine</code> class gets extended.</p>
</div>
</div>
<div class="sect2">
<h3 id="_all_settings_are_bundled_in_one_config_parameter"><a class="anchor" href="#_all_settings_are_bundled_in_one_config_parameter"></a>All settings are bundled in one Config parameter</h3>
<div class="paragraph">
<p>The configuration of the state machine can be defined with a config structure. The default config looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// Default config:
struct default_state_machine_config
{
    using compile_policy = favor_runtime_speed;
    using context = no_context;
    using root_sm = no_root_sm;
    using fsm_parameter = transition_owner;
    template&lt;typename T&gt;
    using queue_container = std::deque&lt;T&gt;;
};

using state_machine_config = default_state_machine_config;

...

// Custom config:
struct CustomStateMachineConfig : public state_machine_config
{
    using compile_policy = favor_compile_time;
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_new_state_machine_setting_for_defining_a_context"><a class="anchor" href="#_new_state_machine_setting_for_defining_a_context"></a>New state machine setting for defining a context</h3>
<div class="paragraph">
<p>The setting <code>context</code> sets up a context member in the state machine for dependency injection.</p>
</div>
<div class="paragraph">
<p>If <code>using context = Context;</code> is defined in the config, a reference to it has to be passed to the state machine constructor as first argument.
The following API becomes available to access it from within the state machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">Context&amp; state_machine::get_context();
const Context&amp; state_machine::get_context() const;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_new_state_machine_setting_for_defining_a_root_sm"><a class="anchor" href="#_new_state_machine_setting_for_defining_a_root_sm"></a>New state machine setting for defining a root sm</h3>
<div class="paragraph">
<p>The setting <code>root_sm</code> defines the type of the root state machine of hierarchical state machines. The root sm depicts the uppermost state machine.</p>
</div>
<div class="paragraph">
<p>If <code>using root_sm = RootSm;</code> is defined in the config, the following API becomes available to access it from within any sub-state machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">RootSm&amp; state_machine::get_root_sm();
const RootSm&amp; state_machine::get_root_sm() const;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is highly recommended to always configure the <code>root_sm</code> in hierarchical state machines, even if access to it is not required.
This reduces the compilation time, because it enables the back-end to instantiate the full set of construction-related methods
only for the root and it can omit them for sub-state machines.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> If a <code>context</code> is used in a hierarchical state machine, then also the <code>root_sm</code> should be set.
The <code>context</code> is then automatically accessed through the <code>root_sm</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_new_state_machine_setting_for_defining_the_fsm_parameter_of_actions_and_guards"><a class="anchor" href="#_new_state_machine_setting_for_defining_the_fsm_parameter_of_actions_and_guards"></a>New state machine setting for defining the <code>Fsm</code> parameter of actions and guards</h3>
<div class="paragraph">
<p>The setting <code>fsm_parameter</code> defines the instance of the <code>Fsm&amp; fsm</code> parameter that is passed to actions and guards in hierarchical state machines.</p>
</div>
<div class="paragraph">
<p>By default it is set to <code>transition_owner</code>, which reflects the same behavior as in <code>back</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Actions and guards with transitions in the same transition table receive the SM instance processing the event, while</p>
</li>
<li>
<p>entry and exit actions receive the SM instance from which the transition originates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can alternatively set it to <code>root_sm</code>, in which case always the root sm is passed as <code>Fsm</code> parameter.
If <code>using fsm_parameter = root_sm;</code> is defined in the config, the setting takes effect.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> If the <code>fsm_parameter</code> is set to <code>root_sm</code>, then also the <code>root_sm</code> must be set.</p>
</div>
</div>
<div class="sect2">
<h3 id="_generic_support_for_serializers"><a class="anchor" href="#_generic_support_for_serializers"></a>Generic support for serializers</h3>
<div class="paragraph">
<p>The <code>state_machine</code> allows access to its private members for serialization purposes with a friend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// Class boost::msm::backmp11::state_machine
template&lt;typename T, typename A0, typename A1, typename A2&gt;
friend void serialize(T&amp;, state_machine&lt;A0, A1, A2&gt;&amp;);</code></pre>
</div>
</div>
<div class="paragraph">
<p>A similar friend declaration is available in the <code>history_impl</code> classes.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> This design allows you to provide any serializer implementation, but due to the need to access private members there is no guarantee that your implementation breaks in a new version of the back-end.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resolved_issues_with_respect_to_back"><a class="anchor" href="#_resolved_issues_with_respect_to_back"></a>Resolved issues with respect to <code>back</code></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_deferring_events_in_orthogonal_regions"><a class="anchor" href="#_deferring_events_in_orthogonal_regions"></a>Deferring events in orthogonal regions</h3>
<div class="paragraph">
<p>Event deferral in orthogonal regions behaves as described in the UML standard:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If one active region decides to defer an event, then it is deferred for all regions instead of being processed</p>
</li>
<li>
<p>The event gets processed once no more active region decides to defer it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In <code>back</code> the event is evaluted by all regions independently. This leads to the same event being processed multiple times (and worst case to infinite recursion).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_changes_with_respect_to_back"><a class="anchor" href="#_other_changes_with_respect_to_back"></a>Other changes with respect to <code>back</code></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_required_minimum_c_version_is_c17"><a class="anchor" href="#_the_required_minimum_c_version_is_c17"></a>The required minimum C&#43;&#43; version is C&#43;&#43;17</h3>
<div class="paragraph">
<p>C&#43;&#43;11 brings the strongly needed variadic template support for MSM, but later C&#43;&#43; versions provide other important features - for example C&#43;&#43;17&#8217;s <code>if constexpr (&#8230;&#8203;)</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_signature_of_the_state_machine_is_changed"><a class="anchor" href="#_the_signature_of_the_state_machine_is_changed"></a>The signature of the state machine is changed</h3>
<div class="paragraph">
<p>Please refer to the simplified state machine signature above for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_history_policy_of_a_state_machine_is_defined_in_the_front_end_instead_of_the_back_end"><a class="anchor" href="#_the_history_policy_of_a_state_machine_is_defined_in_the_front_end_instead_of_the_back_end"></a>The history policy of a state machine is defined in the front-end instead of the back-end</h3>
<div class="paragraph">
<p>The definition of the history policy is closer related to the front-end, and defining it there ensures that state machine configs can be shared between back-ends.
The definition looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">struct no_history {};

template &lt;typename... Events&gt;
struct shallow_history {};

struct always_shallow_history {};

...

// User-defined state machine
struct Playing_ : public msm::front::state_machine_def&lt;Playing_&gt;
{
    using history = msm::front::shallow_history&lt;end_pause&gt;;
    ...
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_public_api_of_state_machine_is_refactored"><a class="anchor" href="#_the_public_api_of_state_machine_is_refactored"></a>The public API of <code>state_machine</code> is refactored</h3>
<div class="paragraph">
<p>All methods that should not be part of the public API are removed from it, redundant methods are removed as well. A few other methods have been renamed.
The following adapter pseudo-code showcases the differences to the <code>back</code> API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">class state_machine_adapter
{
    // The new API returns a const std::array&lt;...&gt;&amp;.
    const int* current_state() const
    {
        return &amp;this-&gt;get_active_state_ids()[0];
    }

    // The history can be accessed like this,
    // but it has to be configured in the front-end.
    auto&amp; get_history()
    {
        return this-&gt;m_history;
    }

    auto&amp; get_message_queue()
    {
        return this-&gt;get_events_queue();
    }

    size_t get_message_queue_size() const
    {
        return this-&gt;get_events_queue().size();
    }

    void execute_queued_events()
    {
        this-&gt;process_queued_events();
    }

    void execute_single_queued_event()
    {
        this-&gt;process_single_queued_event();
    }

    auto&amp; get_deferred_queue()
    {
        return this-&gt;get_deferred_events_queue();
    }

    void clear_deferred_queue()
    {
        this-&gt;get_deferred_events_queue().clear();
    }

    template &lt;class Flag&gt;
    bool is_flag_active&lt;Flag, Flag_AND&gt;() const
    {
        return is_flag_active&lt;Flag, std::logical_and&lt;bool&gt;&gt;();
    }

    // No adapter.
    // Superseded by the visitor API.
    // void visit_current_states(...) {...}

    // No adapter.
    // States can be set with `get_state&lt;...&gt;()` or the visitor API.
    // void set_states(...) {...}

    // No adapter.
    // Could be implemented with the visitor API.
    // auto get_state_by_id(int id) {...}
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>A working code example of such an adapter is available in <a href="https://github.com/boostorg/msm/blob/develop/test/Backmp11Adapter.hpp">the tests</a>.
It can be copied and adapted if needed, though this class is internal to the tests and not planned to be supported officially.</p>
</div>
<div class="paragraph">
<p>Further details about the applied API changes:</p>
</div>
<div class="sect3">
<h4 id="_the_dependency_to_boostserialization_is_removed"><a class="anchor" href="#_the_dependency_to_boostserialization_is_removed"></a>The dependency to <code>boost::serialization</code> is removed</h4>
<div class="paragraph">
<p>The back-end aims to support serialization in general, but without providing a concrete implementation for a specific serialization library.
If you want to use <code>boost::serialization</code> for your state machine, you can look into the <a href="https://github.com/boostorg/msm/blob/develop/test/Backmp11Adapter.hpp">state machine adapter</a> from the tests for an example how to set it up.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_back_ends_constructor_does_not_allow_initialization_of_states_and_set_states_is_removed"><a class="anchor" href="#_the_back_ends_constructor_does_not_allow_initialization_of_states_and_set_states_is_removed"></a>The back-end&#8217;s constructor does not allow initialization of states and <code>set_states</code> is removed</h4>
<div class="paragraph">
<p>There were some caveats with one constructor that was used for different use cases: On the one hand some arguments were immediately forwarded to the front-end&#8217;s constructor, on the other hand the stream operator was used to identify other arguments in the constructor as states, to copy them into the state machine. Besides the syntax of the later being rather unusual, when doing both at once the syntax becomes too difficult to understand; even more so if states within hierarchical sub state machines were initialized in this fashion.</p>
</div>
<div class="paragraph">
<p>In order to keep the API of the constructor simpler and less ambiguous, it only supports forwarding arguments to the front-end and no more.
Also the <code>set_states</code> API is removed. If setting a state is required, this can still be done (in a little more verbose, but also more direct &amp; explicit fashion) by getting a reference to the desired state via <code>get_state</code> and then assigning the desired new state to it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_method_get_state_by_id_is_removed"><a class="anchor" href="#_the_method_get_state_by_id_is_removed"></a>The method <code>get_state_by_id</code> is removed</h4>
<div class="paragraph">
<p>If you really need to get a state by id, please use the universal visitor API to implement the function on your own.
The backmp11 state_machine has a new method to support getting the id of a state in the visitor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">template&lt;typename State&gt;
static constexpr int state_machine::get_state_id(const State&amp;);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_pointer_overload_of_get_state_is_removed"><a class="anchor" href="#_the_pointer_overload_of_get_state_is_removed"></a>The pointer overload of <code>get_state</code> is removed</h4>
<div class="paragraph">
<p>Similarly to the STL&#8217;s <code>std::get</code> of a tuple, the only sensible template parameter for <code>get_state</code> is <code>T</code> returning a <code>T&amp;</code>.
The overload for a <code>T*</code> is removed and the <code>T&amp;</code> is discouraged, although still supported.
If you need to get a state by its address, use the address operator after you have received the state by reference.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_boostany_as_kleene_event_is_replaced_by_stdany"><a class="anchor" href="#_boostany_as_kleene_event_is_replaced_by_stdany"></a><code>boost::any</code> as Kleene event is replaced by <code>std::any</code></h3>
<div class="paragraph">
<p>To reduce the amount of necessary header inclusions <code>backmp11</code> uses <code>std::any</code> for defining Kleene events instead of <code>boost::any</code>.
You can still opt in to use <code>boost::any</code> by explicitly including <code>boost/msm/event_traits.h</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_euml_front_end_support_is_removed"><a class="anchor" href="#_the_euml_front_end_support_is_removed"></a>The eUML front-end support is removed</h3>
<div class="paragraph">
<p>The support of EUML induces longer compilation times by the need to include the Boost proto headers and applying C&#43;&#43;03 variadic template emulation. If you want to use a UML-like syntax, please try out the new PUML front-end.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_fsm_check_and_find_region_support_is_removed"><a class="anchor" href="#_the_fsm_check_and_find_region_support_is_removed"></a>The fsm check and find region support is removed</h3>
<div class="paragraph">
<p>The implementation of these two features depends on mpl_graph, which induces high compilation times.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sm_ptr_support_is_removed"><a class="anchor" href="#_sm_ptr_support_is_removed"></a><code>sm_ptr</code> support is removed</h3>
<div class="paragraph">
<p>Not needed with the functor front-end and was already deprecated, thus removed in <code>backmp11</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_use_it"><a class="anchor" href="#_how_to_use_it"></a>How to use it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The back-end with both its compile policies <code>favor_runtime_speed</code> and <code>favor_compile_time</code> should be mostly compatible with existing code.</p>
</div>
<div class="paragraph">
<p>Required replacements to try it out:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for the state machine use <code>boost::msm::backmp11::state_machine</code> in place of <code>boost::msm::back::state_machine</code> and</p>
</li>
<li>
<p>for configuring the compile policy and more use <code>boost::msm::backmp11::state_machine_config</code></p>
</li>
<li>
<p>if you encounter API-incompatibilities please check the <a href="#_other_changes_with_respect_to_back">details above</a> for reference</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since the back-end should compile very fast for most machines, the manual generation of state machines with the <code>favor_compile_time</code> policy has become an opt-in feature.
If you want to build your state machine across multiple compilation units, you need to do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>set up a preprocessor define <code>BOOST_MSM_BACKMP11_MANUAL_GENERATION</code> before including <code>msm/backmp11/favor_compile_time.hpp</code></p>
</li>
<li>
<p>then generate your state machine(s) in the compilation units with the macro <code>BOOST_MSM_BACKMP11_GENERATE_STATE_MACHINE(&lt;smname&gt;)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find an example for this in the <a href="https://github.com/boostorg/msm/blob/develop/test/Backmp11Visitor.cpp">visitor test</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_applied_optimizations"><a class="anchor" href="#_applied_optimizations"></a>Applied optimizations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below you can find some insights how the compile-time and runtime optimizations were achieved.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replacement of CPU-intensive calls (due to C&#43;&#43;03 recursion from MPL) with Mp11</p>
</li>
<li>
<p>Replaced O(N) algorithms with O(1) alternatives (using additional dispatch tables)</p>
</li>
<li>
<p>Added more type filters prior to template instantiations</p>
</li>
<li>
<p>Applied type punning where useful (to reduce template instantiations, e.g. <code>std::deque</code> &amp; other things around the dispatch table)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_favor_runtime_speed_policy"><a class="anchor" href="#_favor_runtime_speed_policy"></a><code>favor_runtime_speed</code> policy</h3>
<div class="paragraph">
<p>Summary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unconditionally default-initialized everything first and afterwards only the row-related transition cells</p>
</li>
<li>
<p>Optimized cell initialization with initializer arrays (to reduce template instantiations)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_favor_compile_time_policy"><a class="anchor" href="#_favor_compile_time_policy"></a><code>favor_compile_time</code> policy</h3>
<div class="paragraph">
<p>Once an event is given to the FSM for processing, it is immediately wrapped with <code>std::any</code> and processing continues with this <code>any</code> event.
The structure of the dispatch table has been reworked, one dispatch table is created per state as a hash map.
The state dispatch tables are designed to directly work with the <code>any</code> event, they use the event&#8217;s type index via its <code>type()</code> function as hash value.</p>
</div>
<div class="paragraph">
<p>This mechanism enables SMs to forward events to sub-SMs without requiring additional template instantiations just for forwarding as was needed with the <code>process_any_event</code> mechanism.
The new mechanism enables <strong>forwarding of events to sub-SMs in O(1) order instead of O(N)</strong>.</p>
</div>
<div class="paragraph">
<p>Summary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use one dispatch table per state to reduce compiler processing time</p>
</li>
<li>
<p>The algorithms for processing the STT and states are optimized to go through rows and states only once</p>
</li>
<li>
<p>These dispatch tables are hash tables with type_id as key</p>
</li>
<li>
<p>Apply type erasure with <code>std::any</code> as early as possible and do further processing only with any events</p>
</li>
<li>
<p>each dispatch table only has to cover the events it&#8217;s handling, no template instantiations required for forwarding events to sub-SMs</p>
</li>
</ul>
</div>
</div>
</div>
</div>
  <div class="edit-this-page">
      <a href="https://github.com/boostorg/msm/edit/develop/doc/modules/ROOT/pages/tutorial/backmp11-back-end.adoc">Edit this Page</a>
      </div>
      <nav class="pagination">
        <span class="prev"><a href="back-end.html">Back-end</a></span>
        <span class="next"><a href="../performance-compilers.html">Performance / Compilers</a></span>
    </nav>
</article>
</div>
  <div id="footer">
  <script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
</div>
</div>
  </body>
</html>
